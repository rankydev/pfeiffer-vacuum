.node-image:
  image: node:16-alpine
  tags:
    - docker_runner

build:
  extends: .node-image
  stage: build
  cache:
    - key: "${CI_PIPELINE_ID}-build-frontend"
      paths:
        - .npm/
        - .nuxt/
        - node_modules/
      policy: push
    - key: "${CI_PIPELINE_ID}-build-lsg"
      paths:
        - lsg-public/
      policy: push
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run build
    - npm run lsg:build
  artifacts:
    when: on_failure
    paths:
      - .npm/_logs
    expire_in: 3 week

lint-styles:
  extends: .node-image
  stage: test
  needs: ["build"]
  cache:
    - key: "${CI_PIPELINE_ID}-build-frontend"
      paths:
        - .npm/
        - .nuxt/
        - node_modules/
      policy: pull
    - key: "${CI_PIPELINE_ID}-report"
      paths:
        - report/
      policy: push
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run lint:style-ci
  artifacts:
    reports:
      junit:
        - "stylelint-test-results.xml"
    expire_in: 3 week
  except:
    - develop

lint-javascript:
  extends: .node-image
  stage: test
  needs: ["build"]
  cache:
    - key: "${CI_PIPELINE_ID}-build-frontend"
      paths:
        - .npm/
        - .nuxt/
        - node_modules/
      policy: pull
    - key: "${CI_PIPELINE_ID}-report"
      paths:
        - report/
      policy: push
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run lint:js-ci
  artifacts:
    reports:
      junit:
        - "eslint-test-results.xml"
    expire_in: 3 week
  except:
    - develop

lint:
  extends: .node-image
  stage: test
  needs: ["build"]
  cache:
    - key: "${CI_PIPELINE_ID}-build-frontend"
      paths:
        - .npm/
        - .nuxt/
        - node_modules/
      policy: pull
    - key: "${CI_PIPELINE_ID}-report"
      paths:
        - report/
      policy: push
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run lint:ci
  artifacts:
    when: always
    paths:
      - report/
    expire_in: 3 week
  only:
    - develop

test:
  extends: .node-image
  stage: test
  needs: ["build"]
  cache:
    - key: "${CI_PIPELINE_ID}-build-frontend"
      paths:
        - .npm/
        - .nuxt/
        - node_modules/
      policy: pull
    - key: "${CI_PIPELINE_ID}-coverage"
      paths:
        - coverage/
      policy: push
  script:
    - npm ci --cache .npm --prefer-offline
    - NODE_ENV=test
    - npm test
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/clover.xml
    paths:
      - coverage/
    expire_in: 3 week

sonar-qube:
  image: sonarsource/sonar-scanner-cli
  stage: analysis
  needs: ["test", "lint"]
  cache:
    - key: "${CI_PIPELINE_ID}-build-frontend"
      paths:
        - .npm/
        - .nuxt/
        - node_modules/
      policy: pull
    - key: "${CI_PIPELINE_ID}-report"
      paths:
        - report/
      policy: pull
    - key: "${CI_PIPELINE_ID}-coverage"
      paths:
        - coverage/
      policy: pull
  script:
    - sonar-scanner -Dsonar.login=${SONARQUBE_ACCESS_TOKEN}
  tags:
    - docker_runner
    - shared
  only:
    - develop

.build-docker-image:
  image: docker:git
  stage: build-docker-image
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_IMAGE_TAG: ${CI_COMMIT_REF_SLUG}
  services:
    - docker:dind
  cache: []
  before_script:
    - # disable gitlab warning for docker login
      echo "${CI_REGISTRY_PASSWORD}" | docker login --username "${CI_REGISTRY_USER}" --password-stdin ${CI_REGISTRY}
  script:
    - docker build
      -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
      $(cat .docker-buildargs | while read line; do buildargs+="--build-arg $line"; done; echo $buildargs; buildargs="")
      -f docker/Dockerfile .
  after_script:
    - # here we will push ALL created tags of an image
      docker push --all-tags ${DOCKER_IMAGE_NAME}
  tags:
    - dind_runner

build-docker-image-frontend:
  extends: .build-docker-image
  needs: ["test", "lint-styles", "lint-javascript"]
  environment:
    name: dev2
  except:
    - develop

.build-docker-image-lsg:
  extends: .build-docker-image
  image: docker:git
  cache:
    - key: "${CI_PIPELINE_ID}-build-lsg"
      paths:
        - lsg-public/
      policy: pull
  script:
    - docker build -t ${DOCKER_IMAGE_NAME}:lsg-${CI_COMMIT_REF_SLUG} -f docker/DockerfileLSG .

build-docker-image-lsg:
  extends: .build-docker-image-lsg
  needs: ["test", "lint-styles", "lint-javascript"]
  except:
    - develop

build-docker-image-frontend-develop:
  extends: .build-docker-image
  needs: ["sonar-qube"]
  environment:
    name: dev2
  only:
    - develop

build-docker-image-lsg-develop:
  extends: .build-docker-image-lsg
  needs: ["sonar-qube"]
  only:
    - develop

tag-docker-image-latest-main:
  extends: .build-docker-image
  needs: ["build-docker-image-frontend"]
  script:
    - docker pull ${DOCKER_IMAGE_NAME}:main
    - docker tag ${DOCKER_IMAGE_NAME}:main ${DOCKER_IMAGE_NAME}:latest
  only:
    - main

build-docker-image-frontend-uat-tags:
  extends: .build-docker-image
  needs: ["test", "lint-styles", "lint-javascript"]
  variables:
    DOCKER_IMAGE_TAG: uat-${CI_COMMIT_REF_SLUG}
  environment:
    name: uat
  only:
    - tags

build-docker-image-frontend-prd-tags:
  extends: .build-docker-image
  needs: ["test", "lint-styles", "lint-javascript"]
  variables:
    DOCKER_IMAGE_TAG: prd-${CI_COMMIT_REF_SLUG}
  environment:
    name: prd
  only:
    - tags

tag-gitlab-nightly:
  needs: ["build-docker-image-frontend-develop"]
  image: docker:git
  stage: build-docker-image
  before_script:
    - git remote remove origin
    - git remote add origin https://"${CI_GITLAB_TAG_WRITE_TOKEN_USERNAME}:${CI_GITLAB_TAG_WRITE_TOKEN_PASSWORD}"@gitlab.diva-e.com/pvac/pvweb.git
  script:
    - git tag  "$(date +'%Y%m%d.%H%M')"
    - git push origin "$(date +'%Y%m%d.%H%M')"
  only:
    - schedules
  tags:
    - docker_runner
